stages:
  - test

variables:
  NODE_ENV: "test"
  BASE_URL: "http://localhost:3000"
  NEXTAUTH_URL: "http://localhost:3000"
  DATABASE_URL: "file:./prisma/dev.db"
  PORT: "3000"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .cache/ms-playwright/

e2e:
  stage: test
  image: node:22
  interruptible: true
  resource_group: "e2e-${CI_COMMIT_REF_SLUG}"
  parallel:
    matrix:
      - BROWSER: [chromium, firefox, webkit]
  before_script:
    - npm ci
    - npx prisma generate
    - npx prisma db push
    - npm run build
    - export NEXTAUTH_SECRET=$(openssl rand -hex 32)
    - npx playwright install --with-deps "$BROWSER"
  script:
    - >
      npx playwright test -c "$( [ -f playwright.config.e2e.ts ] && echo playwright.config.e2e.ts || echo playwright.config.ts )" --project="$BROWSER" --reporter=html,json=playwright-results.json
  artifacts:
    when: always
    name: "playwright-report-$BROWSER-$CI_JOB_ID"
    expire_in: 7 days
    paths:
      - playwright-report/
      - playwright-results.json
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  timeout: 20m
