name: Data Invariants

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  invariants:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      POSTGRES_USER: postgres
      POSTGRES_DB: nexus_dev
      DATABASE_PASSWORD: postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Postgres (Docker Compose)
        run: |
          docker compose up -d postgres-db

      - name: Wait for DB ready
        run: |
          for i in {1..60}; do
            if docker compose exec -T postgres-db pg_isready -U ${POSTGRES_USER} -d postgres; then exit 0; fi
            sleep 2
          done
          echo "DB did not become ready" >&2
          exit 1

      - name: Ensure payments uniqueness (method, externalId)
        run: |
          set -e
          SQL="SELECT COUNT(*) FROM (SELECT method, \"externalId\", COUNT(*) c FROM payments WHERE \"externalId\" IS NOT NULL GROUP BY 1,2 HAVING COUNT(*)>1) d;"
          DUPES=$(docker compose exec -T postgres-db psql -U ${POSTGRES_USER} -d postgres -t -c "$SQL" | tr -d '[:space:]')
          echo "payments_duplicate_tuples=${DUPES}"
          if [ "${DUPES}" != "0" ]; then
            echo "Found duplicate (method, externalId) tuples in payments" >&2
            exit 1
          fi

      - name: Validate payments status values
        run: |
          set -e
          SQL="SELECT COUNT(*) FROM payments WHERE status NOT IN ('PENDING','COMPLETED','FAILED','REFUNDED');"
          BAD=$(docker compose exec -T postgres-db psql -U ${POSTGRES_USER} -d postgres -t -c "$SQL" | tr -d '[:space:]')
          if [ "${BAD}" != "0" ]; then
            echo "Invalid payment statuses found" >&2
            exit 1
          fi

