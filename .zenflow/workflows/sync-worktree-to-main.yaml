name: sync-worktree-to-main
version: 1.0.0
description: Synchronize a worktree branch to main directory
author: zenflow-system

inputs:
  - name: worktree_branch
    type: string
    required: true
    description: Branch name of the worktree to sync
  
  - name: commit_hash
    type: string
    required: true
    description: Commit hash that triggered the sync
  
  - name: dry_run
    type: boolean
    default: false
    description: Preview changes without applying

outputs:
  - name: sync_status
    type: string
    description: "success, conflict, or failure"
  
  - name: files_changed
    type: number
    description: Number of files modified
  
  - name: commit_id
    type: string
    description: Commit hash of sync in main

steps:
  - id: validate-worktree
    name: Validate Worktree Exists
    type: shell
    command: |
      git worktree list | grep -q "${inputs.worktree_branch}" || exit 1
    on_failure: abort
  
  - id: check-conflicts
    name: Check for Merge Conflicts
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      git merge-tree $(git merge-base main ${inputs.worktree_branch}) main ${inputs.worktree_branch} | grep -q "<<<<<" && exit 1 || exit 0
    on_failure: skip_to_step:report-conflicts
  
  - id: analyze-diff
    name: Analyze Differences
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      git diff --stat main...${inputs.worktree_branch} > /tmp/zenflow-diff-stats.txt
      git diff --name-status main...${inputs.worktree_branch} > /tmp/zenflow-diff-files.txt
      echo "Files changed: $(wc -l < /tmp/zenflow-diff-files.txt)"
    outputs:
      files_changed: /tmp/zenflow-diff-files.txt
  
  - id: backup-main
    name: Create Backup
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      timestamp=$(date +%Y%m%d-%H%M%S)
      git stash push --include-untracked -m "zenflow-backup-${timestamp}-${inputs.worktree_branch}"
      echo "Backup created: zenflow-backup-${timestamp}-${inputs.worktree_branch}"
    unless: ${inputs.dry_run}
  
  - id: merge-changes
    name: Merge Worktree to Main
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      git merge --no-ff ${inputs.worktree_branch} -m "chore: merge ${inputs.worktree_branch} - Auto-sync from Zenflow

      Triggered by commit: ${inputs.commit_hash}
      Workflow: sync-worktree-to-main
      Timestamp: $(date -Iseconds)"
    unless: ${inputs.dry_run}
    timeout: 300
    on_failure: rollback_to_step:backup-main
  
  - id: run-lint
    name: Run Linting
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      npm run lint
    timeout: 120
    continue_on_error: true
    unless: ${inputs.dry_run}
  
  - id: run-typecheck
    name: Run Type Checking
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      npm run typecheck
    timeout: 180
    on_failure: rollback_to_step:backup-main
    unless: ${inputs.dry_run}
  
  - id: push-to-remote
    name: Push to GitHub
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      git push origin main
    timeout: 60
    on_failure: continue
    unless: ${inputs.dry_run}
  
  - id: cleanup-backup
    name: Remove Backup
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      git stash drop
    continue_on_error: true
    unless: ${inputs.dry_run}
  
  - id: log-success
    name: Log Successful Sync
    type: shell
    command: |
      echo "Sync completed successfully"
      echo "Worktree: ${inputs.worktree_branch}"
      echo "Commit: ${inputs.commit_hash}"
      echo "Files changed: $(wc -l < /tmp/zenflow-diff-files.txt)"
  
  - id: report-conflicts
    name: Report Merge Conflicts
    type: shell
    when: step:check-conflicts == failure
    command: |
      echo "ERROR: Merge conflicts detected between main and ${inputs.worktree_branch}"
      echo "Conflicted files:"
      cd /home/alaeddine/Bureau/nexus-project_v0
      git diff --name-only --diff-filter=U main...${inputs.worktree_branch}
      exit 1

error_handling:
  strategy: rollback
  cleanup_steps:
    - name: Restore from Backup
      type: shell
      when: step:backup-main == success
      command: |
        cd /home/alaeddine/Bureau/nexus-project_v0
        git reset --hard HEAD~1
        git stash pop
    
    - name: Log Failure
      type: shell
      command: |
        echo "Sync failed for ${inputs.worktree_branch}" >> /var/log/zenflow/failures.log
        echo "Error: ${error.message}" >> /var/log/zenflow/failures.log

notifications:
  on_success:
    - type: log
      level: info
      message: "Successfully synced ${inputs.worktree_branch} to main (${outputs.files_changed} files)"
  
  on_failure:
    - type: log
      level: error
      message: "Failed to sync ${inputs.worktree_branch}: ${error.message}"
