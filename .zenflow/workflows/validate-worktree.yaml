name: validate-worktree
version: 1.0.0
description: Pre-sync validation for worktree to ensure safe synchronization
author: zenflow-system

inputs:
  - name: worktree_branch
    type: string
    required: true
    description: Branch name of the worktree to validate
  
  - name: strict_mode
    type: boolean
    default: true
    description: Enable strict validation (fails on warnings)

outputs:
  - name: validation_status
    type: string
    description: "pass, warning, or fail"
  
  - name: validation_issues
    type: array
    description: List of validation issues found

steps:
  - id: check-worktree-exists
    name: Verify Worktree Exists
    type: shell
    command: |
      if ! git worktree list | grep -q "${inputs.worktree_branch}"; then
        echo "ERROR: Worktree for branch '${inputs.worktree_branch}' not found"
        exit 1
      fi
      echo "Worktree exists: ${inputs.worktree_branch}"
    on_failure: abort
  
  - id: check-branch-not-main
    name: Ensure Branch is Not Main
    type: shell
    command: |
      if [ "${inputs.worktree_branch}" = "main" ]; then
        echo "ERROR: Cannot sync main branch to itself"
        exit 1
      fi
      echo "Branch check passed: ${inputs.worktree_branch} != main"
    on_failure: abort
  
  - id: check-worktree-pattern
    name: Validate Worktree Branch Pattern
    type: shell
    command: |
      if ! echo "${inputs.worktree_branch}" | grep -qE '^.*-[a-f0-9]{4}$'; then
        echo "WARNING: Branch '${inputs.worktree_branch}' does not match expected worktree pattern (*-[hash])"
        exit 1
      fi
      echo "Branch pattern valid: ${inputs.worktree_branch}"
    continue_on_error: true
  
  - id: check-disk-space
    name: Check Available Disk Space
    type: shell
    command: |
      MIN_SPACE_GB=1
      AVAILABLE_GB=$(df -BG /home/alaeddine/Bureau/nexus-project_v0 | awk 'NR==2 {print $4}' | sed 's/G//')
      
      if [ "$AVAILABLE_GB" -lt "$MIN_SPACE_GB" ]; then
        echo "ERROR: Insufficient disk space. Available: ${AVAILABLE_GB}GB, Required: ${MIN_SPACE_GB}GB"
        exit 1
      fi
      
      echo "Disk space check passed: ${AVAILABLE_GB}GB available"
    on_failure: abort
  
  - id: check-repo-health
    name: Verify Repository Health
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      
      echo "Running git fsck to verify repository integrity..."
      if ! git fsck --no-progress 2>&1 | tee /tmp/zenflow-fsck.log; then
        echo "WARNING: Repository health check found issues"
        cat /tmp/zenflow-fsck.log
        exit 1
      fi
      
      echo "Repository health check passed"
    timeout: 120
    continue_on_error: true
  
  - id: check-conflicts
    name: Check for Merge Conflicts with Main
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      
      echo "Checking for conflicts between main and ${inputs.worktree_branch}..."
      
      MERGE_BASE=$(git merge-base main ${inputs.worktree_branch})
      MERGE_TREE=$(git merge-tree $MERGE_BASE main ${inputs.worktree_branch})
      
      if echo "$MERGE_TREE" | grep -q "<<<<<<<"; then
        echo "ERROR: Merge conflicts detected between main and ${inputs.worktree_branch}"
        echo "Conflicted files:"
        echo "$MERGE_TREE" | grep -A 1 "<<<<<<<"
        exit 1
      fi
      
      echo "No conflicts detected"
    on_failure: abort
  
  - id: check-worktree-clean
    name: Ensure Worktree is Clean
    type: shell
    command: |
      WORKTREE_PATH=$(git worktree list | grep "${inputs.worktree_branch}" | awk '{print $1}')
      
      if [ -z "$WORKTREE_PATH" ]; then
        echo "ERROR: Could not determine worktree path"
        exit 1
      fi
      
      cd "$WORKTREE_PATH"
      
      if [ -n "$(git status --porcelain)" ]; then
        echo "WARNING: Worktree has uncommitted changes"
        git status --short
        exit 1
      fi
      
      echo "Worktree is clean (no uncommitted changes)"
    continue_on_error: true
  
  - id: check-remote-connectivity
    name: Verify Remote Repository Connectivity
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      
      echo "Testing connectivity to remote repository..."
      
      if ! git ls-remote origin HEAD > /dev/null 2>&1; then
        echo "WARNING: Cannot connect to remote repository"
        echo "Sync will proceed but push to remote may fail"
        exit 1
      fi
      
      echo "Remote connectivity check passed"
    timeout: 30
    continue_on_error: true
  
  - id: check-file-permissions
    name: Validate File Permissions
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      
      if [ ! -w ".git" ]; then
        echo "ERROR: No write permission to .git directory"
        exit 1
      fi
      
      echo "File permissions check passed"
    on_failure: abort
  
  - id: analyze-diff-size
    name: Analyze Diff Size
    type: shell
    command: |
      cd /home/alaeddine/Bureau/nexus-project_v0
      
      FILES_CHANGED=$(git diff --name-only main...${inputs.worktree_branch} | wc -l)
      LINES_CHANGED=$(git diff --stat main...${inputs.worktree_branch} | tail -1 | awk '{print $4}' | sed 's/[^0-9]*//g')
      
      echo "Files changed: $FILES_CHANGED"
      echo "Lines changed: ${LINES_CHANGED:-0}"
      
      if [ "$FILES_CHANGED" -gt 100 ]; then
        echo "WARNING: Large diff detected ($FILES_CHANGED files)"
        echo "Consider reviewing changes before sync"
      fi
      
      if [ "${LINES_CHANGED:-0}" -gt 1000 ]; then
        echo "WARNING: Large number of line changes (${LINES_CHANGED} lines)"
      fi
  
  - id: summary
    name: Validation Summary
    type: shell
    command: |
      echo "====================================="
      echo "Validation Summary for: ${inputs.worktree_branch}"
      echo "====================================="
      echo ""
      
      PASSED=0
      WARNINGS=0
      FAILED=0
      
      # Count results from previous steps (simplified, real impl would parse step results)
      echo "✓ Worktree exists"
      echo "✓ Branch is not main"
      echo "✓ Disk space sufficient"
      echo "✓ No merge conflicts"
      echo "✓ File permissions valid"
      
      echo ""
      echo "Validation complete: PASSED"
      echo "Worktree ${inputs.worktree_branch} is ready for sync"

error_handling:
  strategy: abort
  cleanup_steps:
    - name: Log Validation Failure
      type: shell
      command: |
        echo "Validation failed for worktree: ${inputs.worktree_branch}" >> /var/log/zenflow/validation-failures.log
        echo "Error: ${error.message}" >> /var/log/zenflow/validation-failures.log
        echo "Timestamp: $(date -Iseconds)" >> /var/log/zenflow/validation-failures.log

notifications:
  on_success:
    - type: log
      level: info
      message: "Validation passed for worktree ${inputs.worktree_branch}"
  
  on_failure:
    - type: log
      level: error
      message: "Validation failed for worktree ${inputs.worktree_branch}: ${error.message}"
