// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// √ânum√©ration des r√¥les utilisateur
enum UserRole {
  ADMIN
  ASSISTANTE
  COACH
  PARENT
  ELEVE
}

// √ânum√©ration des statuts d'abonnement
enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
}

// √ânum√©ration des types de prestations
enum ServiceType {
  COURS_ONLINE
  COURS_PRESENTIEL
  ATELIER_GROUPE
}

// √ânum√©ration des mati√®res
enum Subject {
  MATHEMATIQUES
  NSI
  FRANCAIS
  PHILOSOPHIE
  HISTOIRE_GEO
  ANGLAIS
  ESPAGNOL
  PHYSIQUE_CHIMIE
  SVT
  SES
}

// √ânum√©ration des statuts de session
enum SessionStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

// √ânum√©ration des types de paiement
enum PaymentType {
  SUBSCRIPTION
  CREDIT_PACK
  SPECIAL_PACK
}

// √ânum√©ration des statuts de paiement
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Mod√®le Utilisateur principal
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  role      UserRole
  firstName String?
  lastName  String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Activation (Mod√®le B: assistante/parent d√©clenche l'activation √©l√®ve)
  activatedAt     DateTime? // null = compte non activ√© (√©l√®ve en attente)
  activationToken String?   // token hash√© pour activation par email
  activationExpiry DateTime? // expiration du token d'activation

  // Relations sp√©cifiques selon le r√¥le
  parentProfile ParentProfile?
  student       Student?
  coachProfile  CoachProfile?

  // Relations communes
  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  payments         Payment[]
  
  // Documents
  documents        UserDocument[] @relation("UserDocuments")
  uploadedDocuments UserDocument[] @relation("DocumentUploader")

  // Coach specific relations
  coachAvailabilities CoachAvailability[] @relation("CoachAvailability")
  coachSessions       SessionBooking[]    @relation("CoachSessions")

  // Student specific relations
  studentSessions SessionBooking[] @relation("StudentSessions")

  // Parent specific relations
  parentSessions SessionBooking[] @relation("ParentSessions")

  // Notification relations
  notifications SessionNotification[] @relation("UserNotifications")

  // Entitlements (product access rights)
  entitlements Entitlement[]

  // ClicToPay transactions
  clicToPayTransactions ClicToPayTransaction[]

  @@index([role])
  @@map("users")
}

// Profil Parent
model ParentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informations sp√©cifiques parent
  address String?
  city    String?
  country String? @default("Tunisie")

  // Relations
  children Student[]

  @@map("parent_profiles")
}

// Mod√®le √âl√®ve (entit√© m√©tier ‚Äî source de v√©rit√© unique pour les donn√©es √©l√®ve)
model Student {
  id       String        @id @default(cuid())
  parentId String
  parent   ParentProfile @relation(fields: [parentId], references: [id], onDelete: Cascade)

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informations scolaires
  grade     String? // Classe
  school    String?
  birthDate DateTime?

  // Cr√©dits et sessions
  credits           Int @default(0)
  totalSessions     Int @default(0)
  completedSessions Int @default(0)

  // Relations
  subscriptions        Subscription[]
  creditTransactions   CreditTransaction[]
  sessions             Session[]
  ariaConversations    AriaConversation[]
  badges               StudentBadge[]
  reports              StudentReport[]
  subscriptionRequests SubscriptionRequest[]
  sessionReports       SessionReport[]
  trajectories         Trajectory[]

  // Learning Graph v2 relations
  assessments          Assessment[]          // Linked assessments (optional FK from Assessment)
  progressionHistory   ProgressionHistory[]  // SSN history over time
  projectionHistory    ProjectionHistory[]   // ML predictions history

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("students")
}

// Profil Coach
model CoachProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informations professionnelles
  title       String? // Agr√©g√©, Certifi√©, etc.
  pseudonym   String  @unique // H√©lios, Z√©non, etc.
  tag         String? // üéì Agr√©g√©, üéØ Strat√®ge, etc.
  description String?
  philosophy  String?
  expertise   String?

  // Sp√©cialit√©s
  subjects Json @default("[]") // Array des subjects enseign√©s

  // Disponibilit√©s
  availableOnline   Boolean @default(true)
  availableInPerson Boolean @default(true)

  // Relations
  sessions       Session[]
  reports        StudentReport[]
  sessionReports SessionReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coach_profiles")
}

// Mod√®le Abonnement
model Subscription {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // D√©tails de l'abonnement
  planName        String // ACCES_PLATEFORME, HYBRIDE, IMMERSION
  monthlyPrice    Int // Prix en TND
  creditsPerMonth Int // Cr√©dits inclus par mois

  // Statut et dates
  status    SubscriptionStatus
  startDate DateTime
  endDate   DateTime?

  // Add-ons ARIA
  ariaSubjects Json @default("[]") // Array des mati√®res ARIA activ√©es
  ariaCost     Int    @default(0) // Co√ªt mensuel des add-ons ARIA

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, status])
  @@map("subscriptions")
}

// Mod√®le Transaction de Cr√©dits
model CreditTransaction {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // D√©tails de la transaction
  type        String // MONTHLY_ALLOCATION, PURCHASE, USAGE, REFUND, EXPIRATION
  amount      Float // Peut √™tre n√©gatif pour les utilisations
  description String

  // M√©tadonn√©es
  sessionId String? // Si li√© √† une session
  expiresAt DateTime? // Pour les cr√©dits avec expiration

  createdAt DateTime @default(now())

  // Note: Database has partial unique indexes to prevent duplicate transactions:
  // - credit_transactions_session_usage_key: one USAGE per session
  // - credit_transactions_session_refund_key: one REFUND per session
  // See migration: 20260201201534_add_credit_transaction_idempotency
  @@index([studentId, createdAt])
  @@index([sessionId])
  @@map("credit_transactions")
}

// Mod√®le Session (Cours/Ateliers)
model Session {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  coachId String?
  coach   CoachProfile? @relation(fields: [coachId], references: [id], onDelete: SetNull) // Preserve session history even if coach account removed

  // D√©tails de la session
  type        ServiceType
  subject     Subject
  title       String
  description String?

  // Planification
  scheduledAt DateTime
  duration    Int // Dur√©e en minutes
  location    String? // Pour le pr√©sentiel ou lien visio

  // Co√ªt et statut
  creditCost Float
  status     SessionStatus @default(SCHEDULED)

  // Compte-rendu
  report     String?
  reportedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([coachId])
  @@index([status])
  @@map("sessions")
}

// Mod√®le Conversation ARIA
model AriaConversation {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  subject Subject
  title   String?

  messages AriaMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, updatedAt])
  @@map("aria_conversations")
}

// Mod√®le Message ARIA
model AriaMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   AriaConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // "user" ou "assistant"
  content String

  // Feedback utilisateur
  feedback Boolean? // true = üëç, false = üëé, null = pas de feedback

  createdAt DateTime @default(now())

  @@index([conversationId, createdAt])
  @@map("aria_messages")
}

// Mod√®le Badge
model Badge {
  id          String  @id @default(cuid())
  name        String  @unique
  description String
  category    String // ASSIDUITE, PROGRESSION, CURIOSITE
  icon        String?
  condition   String // Condition d'obtention

  // Relations
  studentBadges StudentBadge[]

  createdAt DateTime @default(now())

  @@map("badges")
}

// Mod√®le Attribution de Badge
model StudentBadge {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  badgeId String
  badge   Badge  @relation(fields: [badgeId], references: [id], onDelete: Cascade) // Changed to Cascade for test compatibility

  earnedAt DateTime @default(now())

  @@unique([studentId, badgeId])
  @@map("student_badges")
}

// Mod√®le Rapport √âl√®ve
model StudentReport {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  coachId String?
  coach   CoachProfile? @relation(fields: [coachId], references: [id], onDelete: SetNull) // Educational records outlive coach employment

  // Contenu du rapport
  title   String
  content String
  period  String // "Semaine du X", "Mois de Y", etc.

  // M√©triques
  sessionsCount   Int     @default(0)
  averageGrade    Float?
  progressNotes   String?
  recommendations String?

  createdAt DateTime @default(now())

  @@map("student_reports")
}

// Mod√®le Paiement
model Payment {
  id     String @id @default(cuid())
  userId String? // Optional to allow keeping payment record if user is deleted
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull) // Preserve history

  // D√©tails du paiement
  type        PaymentType
  amount      Float
  currency    String      @default("TND")
  description String

  // Statut et m√©thode
  status PaymentStatus @default(PENDING)
  method String? // "clictopay", "bank_transfer", "cash", "check"

  // M√©tadonn√©es
  externalId String? // ID de transaction externe
  metadata   Json? // Donn√©es suppl√©mentaires

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clicToPayTransaction ClicToPayTransaction?

  // Ensure payment idempotency: prevent duplicate payments from webhook retries
  @@unique([externalId, method], name: "payments_externalId_method_key")
  @@map("payments")
}

// Mod√®le Transaction ClicToPay (Banque Zitouna)
model ClicToPayTransaction {
  id            String   @id @default(cuid())
  orderId       String   @unique // Identifiant unique envoy√© √† ClicToPay
  amount        Float
  currency      String   @default("TND")
  status        String   @default("PENDING") // PENDING, SUCCESS, FAILED
  bankReference String?  // Num√©ro d'autorisation renvoy√© par la banque
  paymentId     String?  @unique
  payment       Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@map("clictopay_transactions")
}

// Mod√®le Message (Chat)
model Message {
  id       String  @id @default(cuid())
  senderId String?
  sender   User?   @relation("MessageSender", fields: [senderId], references: [id], onDelete: SetNull) // Preserve communication history while anonymizing deleted users

  receiverId String?
  receiver   User?   @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: SetNull) // Preserve communication history while anonymizing deleted users

  content  String
  fileUrl  String? // Pour les pi√®ces jointes
  fileName String?

  readAt DateTime?

  createdAt DateTime @default(now())

  @@map("messages")
}

// Mod√®le Contenu P√©dagogique (pour ARIA)
model PedagogicalContent {
  id      String  @id @default(cuid())
  title   String
  content String
  subject Subject
  grade   String? // Niveau scolaire

  // M√©tadonn√©es pour la recherche vectorielle
  embedding        Json                    @default("[]") // Legacy: kept for compatibility
  embedding_vector Unsupported("vector")? // New: pgvector support (1536 dimensions)
  tags             Json                    @default("[]") // Tags de cat√©gorisation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pedagogical_contents")
}

// Mod√®le pour les demandes de modification d'abonnement
model SubscriptionRequest {
  id               String    @id @default(cuid())
  studentId        String
  requestType      String // PLAN_CHANGE, ARIA_ADDON, INVOICE_DETAILS
  planName         String?
  monthlyPrice     Float
  reason           String?
  status           String // PENDING, APPROVED, REJECTED
  requestedBy      String
  requestedByEmail String
  processedBy      String?
  processedAt      DateTime?
  rejectionReason  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("subscription_requests")
}

// Mod√®le pour les notifications syst√®me
model Notification {
  id        String   @id @default(cuid())
  userId    String // ID de l'utilisateur qui re√ßoit la notification
  userRole  UserRole // R√¥le de l'utilisateur (ASSISTANTE, ADMIN, etc.)
  type      String // SUBSCRIPTION_REQUEST, CREDIT_REQUEST, etc.
  title     String
  message   String
  data      Json // Donn√©es suppl√©mentaires structur√©es
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, read])
  @@index([userRole])
  @@map("notifications")
}

// Add these models to your existing schema

// Coach Availability Management
model CoachAvailability {
  id      String @id @default(cuid())
  coachId String
  coach   User   @relation("CoachAvailability", fields: [coachId], references: [id], onDelete: Cascade)

  // Day of week (0 = Sunday, 1 = Monday, etc.)
  dayOfWeek Int
  startTime String // "09:00"
  endTime   String // "17:00"

  // For specific dates (holidays, special availability)
  specificDate DateTime?
  isAvailable  Boolean   @default(true)

  // Recurring pattern
  isRecurring Boolean   @default(true)
  validFrom   DateTime  @default(now())
  validUntil  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachId, dayOfWeek, startTime, endTime, specificDate])
  @@index([coachId, dayOfWeek])
  @@index([coachId, specificDate])
}

// Session Booking Management
model SessionBooking {
  id String @id @default(cuid())

  // Participants
  studentId String
  student   User    @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  coachId   String
  coach     User    @relation("CoachSessions", fields: [coachId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    User?   @relation("ParentSessions", fields: [parentId], references: [id], onDelete: SetNull)

  // Session Details
  subject     Subject
  title       String
  description String?

  // Scheduling
  scheduledDate DateTime
  startTime     String // "14:00"
  endTime       String // "15:00"
  duration      Int // Duration in minutes

  // Status Management
  status SessionStatus @default(SCHEDULED)

  // Session Type
  type     SessionType     @default(INDIVIDUAL)
  modality SessionModality @default(ONLINE)

  // Location/Meeting Info
  meetingUrl String?
  meetingId  String?
  location   String?

  // Credits & Payment
  creditsUsed Int @default(1)

  // Feedback & Notes
  coachNotes   String?
  studentNotes String?
  rating       Int? // 1-5 stars
  feedback     String?

  // Attendance
  studentAttended Boolean?
  coachAttended   Boolean  @default(true)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  cancelledAt DateTime?

  // Email reminders tracking (avoid duplicate sends at session level)
  reminderSent Boolean @default(false)

  // Relations
  notifications SessionNotification[]
  reminders     SessionReminder[]
  report        SessionReport?

  // Note: Database has EXCLUDE constraint "SessionBooking_no_overlap_excl" to prevent
  // overlapping bookings for same coach/date (Prisma doesn't support EXCLUDE syntax)
  // See migration: 20260201201415_add_session_overlap_prevention

  @@index([studentId, scheduledDate])
  @@index([coachId, scheduledDate])
  @@index([status, scheduledDate])
  @@index([scheduledDate])
}

// Session Report Management
model SessionReport {
  id        String         @id @default(cuid())
  sessionId String         @unique
  session   SessionBooking @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Participants (duplicated for quick access)
  studentId String
  student   Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  coachId   String
  coach     CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  // Report Content
  summary           String // General session summary
  topicsCovered     String // Topics covered during the session
  performanceRating Int // 1-5 stars
  progressNotes     String // Student progress observations
  recommendations   String // Recommendations for next sessions

  // Attendance & Engagement
  attendance      Boolean // Student attended
  engagementLevel EngagementLevel? // LOW, MEDIUM, HIGH

  // Homework & Next Steps
  homeworkAssigned String? // Homework assigned (optional)
  nextSessionFocus String? // Suggested focus for next session (optional)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, createdAt])
  @@index([coachId, createdAt])
  @@map("session_reports")
}

// Notification System
model SessionNotification {
  id        String         @id @default(cuid())
  sessionId String
  session   SessionBooking @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Recipients
  userId String
  user   User   @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // Notification Details
  type    NotificationType
  title   String
  message String

  // Status
  status NotificationStatus @default(PENDING)
  sentAt DateTime?
  readAt DateTime?

  // Delivery Method
  method NotificationMethod @default(EMAIL)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId, type, method])
  @@index([userId, status])
  @@index([sessionId])
}

// Reminder System
model SessionReminder {
  id        String         @id @default(cuid())
  sessionId String
  session   SessionBooking @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Reminder Timing
  reminderType ReminderType
  scheduledFor DateTime

  // Status
  sent   Boolean   @default(false)
  sentAt DateTime?

  // Prevent sending reminders multiple times
  reminderSent Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([sessionId, reminderType])
  @@index([scheduledFor, sent])
  @@index([sessionId])
}

// Enums

enum SessionType {
  INDIVIDUAL
  GROUP
  MASTERCLASS
}

enum SessionModality {
  ONLINE
  IN_PERSON
  HYBRID
}

enum NotificationType {
  SESSION_BOOKED
  SESSION_CONFIRMED
  SESSION_REMINDER
  SESSION_CANCELLED
  SESSION_RESCHEDULED
  SESSION_COMPLETED
  COACH_ASSIGNED
  PAYMENT_REQUIRED
}

// Cron Job Execution Tracking
model CronExecution {
  id           String              @id @default(cuid())
  jobName      String // e.g., "monthly-allocation", "credit-expiration"
  executionKey String // e.g., "2026-02" for monthly jobs, or timestamp for others
  status       CronExecutionStatus
  startedAt    DateTime            @default(now())
  completedAt  DateTime?
  error        String?
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobName, executionKey], name: "cron_executions_job_key")
  @@index([status])
  @@index([startedAt])
  @@map("cron_executions")
}

enum CronExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum NotificationMethod {
  EMAIL
  SMS
  IN_APP
  PUSH
}

enum ReminderType {
  ONE_DAY_BEFORE
  TWO_HOURS_BEFORE
  THIRTY_MINUTES_BEFORE
  SESSION_STARTING
}

enum EngagementLevel {
  LOW
  MEDIUM
  HIGH
}

// Diagnostic Model ‚Äî Generic engine (multi-level, multi-EDS)
model Diagnostic {
  id            String @id @default(cuid())
  publicShareId String @unique @default(cuid()) // Secure public access token (non-guessable)

  // Type de diagnostic (legacy)
  type String // "PALLIER2_MATHS", "DIAGNOSTIC_PRE_STAGE_MATHS", etc.

  // Definition engine metadata
  definitionKey     String?  // e.g. "maths-premiere-p2", "nsi-terminale-p2"
  definitionVersion String?  // e.g. "v1.3"
  promptVersion     String?  // e.g. "v1.0" ‚Äî tracks prompt template version
  modelUsed         String?  // e.g. "llama3.2:latest" ‚Äî LLM model used for generation
  ragUsed           Boolean  @default(false) // Whether RAG context was available
  ragCollections    String[] // Collections used for RAG search

  // Informations √©l√®ve
  studentFirstName String
  studentLastName  String
  studentEmail     String
  studentPhone     String?

  // Contexte scolaire
  establishment    String?
  teacherName      String?
  mathAverage      String?
  specialtyAverage String?
  bacBlancResult   String?
  classRanking     String?

  // Donn√©es du diagnostic (JSON brut soumis)
  data Json?

  // Statut explicite du pipeline
  // RECEIVED ‚Üí VALIDATED ‚Üí SCORED ‚Üí GENERATING ‚Üí ANALYZED ‚Üí FAILED
  status String @default("RECEIVED")

  // R√©sultat de l'analyse IA (legacy ‚Äî kept for backward compat)
  analysisResult String? // JSON string with {eleve, parents, nexus, generatedAt}
  actionPlan     String? // Plan d'action personnalis√© (legacy)

  // Structured analysis (V2 ‚Äî exploitable)
  analysisJson     Json?    // Structured JSON: forces, faiblesses, plan, ressources, qualityFlags
  studentMarkdown  String?  // Rendered bilan for student audience
  parentsMarkdown  String?  // Rendered bilan for parents audience
  nexusMarkdown    String?  // Rendered bilan for Nexus team audience

  // Error tracking
  errorCode    String?  // e.g. "OLLAMA_TIMEOUT", "RAG_UNAVAILABLE", "VALIDATION_ERROR"
  errorDetails String?  // Detailed error message (not exposed publicly)
  retryCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, status])
  @@index([studentEmail])
  @@index([publicShareId])
  @@index([definitionKey, status])
  @@map("diagnostics")
}

// Stage Reservation ‚Äî Persists stage registration leads
model StageReservation {
  id            String   @id @default(cuid())
  parentName    String
  studentName   String?  // Optional: if form distinguishes parent/student
  email         String
  phone         String
  classe        String
  academyId     String
  academyTitle  String
  price         Float
  paymentMethod String?  // "card" | "transfer" | null

  // Pipeline status
  status String @default("PENDING") // PENDING, CONFIRMED, CANCELLED, PAID

  // Scoring (filled after QCM diagnostic)
  scoringResult Json? // { globalScore, confidenceIndex, radarData, strengths, weaknesses }

  // Telegram notification tracking
  telegramSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, academyId]) // Anti-duplicate: one reservation per email per academy
  @@index([status])
  @@index([academyId])
  @@map("stage_reservations")
}

// Assessment Model ‚Äî Universal evaluation system (multi-subject, multi-grade)
enum AssessmentStatus {
  PENDING
  SCORING
  GENERATING
  COMPLETED
  FAILED
}

model Assessment {
  id            String           @id @default(cuid())
  publicShareId String           @unique @default(cuid()) // Secure public access token
  
  // Subject and Grade
  subject String // MATHS, NSI, etc.
  grade   String // PREMIERE, TERMINALE
  
  // Student Information (studentEmail kept for backward compat + anonymous assessments)
  studentEmail    String
  studentName     String
  studentPhone    String?
  studentMetadata Json? // Additional student data
  
  // Optional FK to Student (linked post-registration, null for anonymous assessments)
  studentId String?
  student   Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  
  // Assessment Data
  answers     Json // Record<questionId, optionId>
  duration    Int? // Duration in milliseconds
  startedAt   DateTime?
  completedAt DateTime?
  
  // Scoring Results
  scoringResult   Json?  // Full ScoringResult from ScoringFactory (contains all metrics)
  globalScore     Float? // Raw score (0-100) = (totalPoints / maxPoints) * 100 ‚Äî denormalized for SQL indexing
  confidenceIndex Float? // Student self-awareness index (0-100) ‚Äî denormalized for SQL indexing
  
  // Score Standardis√© Nexus (SSN) ‚Äî normalized by cohort (z-score projection 0-100)
  ssn Float? // null until cohort normalization is computed
  
  // Unified Academic Index (multi-discipline composite, null if single-discipline)
  uai Float?
  
  // Analysis Results
  analysisJson     Json? // Structured analysis (forces, faiblesses, plan)
  studentMarkdown  String? // Rendered bilan for student
  parentsMarkdown  String? // Rendered bilan for parents
  nexusMarkdown    String? // Rendered bilan for Nexus team
  
  // Status and Pipeline
  status   AssessmentStatus @default(PENDING)
  progress Int              @default(0) // 0-100
  
  // Error Tracking
  errorCode    String?
  errorDetails String?
  retryCount   Int     @default(0)
  
  // Versioning ‚Äî track which question bank and scoring engine were used
  assessmentVersion String? // e.g. "maths_terminale_spe_v1", "general_v1"
  engineVersion     String? // e.g. "scorer_v2.1", "generic_v1"
  
  // Metadata
  userAgent String?
  ipAddress String?
  
  // Learning Graph v2 relations
  domainScores DomainScore[]
  skillScores  SkillScore[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([subject, grade])
  @@index([studentEmail])
  @@index([studentId])
  @@index([status])
  @@index([ssn])
  @@index([createdAt])
  @@map("assessments")
}

// ‚îÄ‚îÄ‚îÄ Learning Graph v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// DomainScore ‚Äî Per-domain score breakdown for an assessment
model DomainScore {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  domain String // e.g. "analysis", "algebra", "prob_stats", "geometry"
  score  Float  // 0-100

  createdAt DateTime @default(now())

  @@index([assessmentId])
  @@index([domain])
  @@map("domain_scores")
}

// SkillScore ‚Äî Per-skill granular score for an assessment
model SkillScore {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  skillTag String // e.g. "limite_polynome", "suite_arithmetique", "module_complexe"
  score    Float  // 0-100

  createdAt DateTime @default(now())

  @@index([assessmentId])
  @@index([skillTag])
  @@map("skill_scores")
}

// ProgressionHistory ‚Äî SSN snapshots over time for longitudinal tracking
model ProgressionHistory {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  ssn  Float    // SSN value at this point in time (0-100)
  date DateTime @default(now())

  @@index([studentId, date])
  @@map("progression_history")
}

// ProjectionHistory ‚Äî ML prediction snapshots for prospective analysis
model ProjectionHistory {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  ssnProjected    Float   // Predicted SSN at horizon (0-100)
  confidenceIndex Float   // Prediction confidence (0-100)
  modelVersion    String  // e.g. "ridge_v1", "ridge_v2"
  inputSnapshot   Json?   // Snapshot of input features used for prediction

  createdAt DateTime @default(now())

  @@index([studentId, createdAt])
  @@map("projection_history")
}

// ‚îÄ‚îÄ‚îÄ Invoicing Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum InvoicePaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  CARD
  CLICTOPAY
}

enum EntitlementStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  REVOKED
}

// Invoice ‚Äî Facture client
model Invoice {
  id     String @id @default(cuid())
  number String @unique // Format: YYYYMM-####

  // Status
  status InvoiceStatus @default(DRAFT)

  // Dates
  issuedAt DateTime @default(now())
  dueAt    DateTime? // √âch√©ance (optionnel)

  // Customer
  customerName    String
  customerEmail   String?
  customerAddress String? // Max 2 lignes (clamp c√¥t√© lib)
  customerId      String? // Identifiant fiscal client (si pro)

  // Issuer (snapshot at invoice time)
  issuerName    String @default("M&M Academy")
  issuerAddress String @default("R√©sidence Narjess 2, Bloc D, Appt 12, Raoued 2056, Ariana, Tunisie")
  issuerMF      String @default("1XXXXXX/X/A/M/000") // Matricule fiscal
  issuerRNE     String? // Registre national des entreprises

  // Amounts in millimes (1 TND = 1000 millimes) ‚Äî integer arithmetic only
  currency      String @default("TND")
  subtotal      Int    @default(0) // in millimes
  discountTotal Int    @default(0) // in millimes
  taxTotal      Int    @default(0) // in millimes
  total         Int    @default(0) // in millimes

  // Tax regime
  taxRegime String @default("TVA_NON_APPLICABLE") // TVA_INCLUSE, TVA_NON_APPLICABLE, EXONERATION

  // Payment
  paymentMethod    InvoicePaymentMethod?
  paymentDetails   Json? // { reference, receivedAt, notes }
  paidAt           DateTime? // When payment was received
  paidAmount       Int?      // Amount paid in millimes (should == total)
  paymentReference String?   // Bank transfer ref, cheque number, etc.

  // Cancellation
  cancelReason String? // Why the invoice was cancelled
  cancelledAt  DateTime? // When it was cancelled

  // PDF storage
  pdfPath String? // Local path or S3 key
  pdfUrl  String? // Public/signed URL

  // Audit
  createdByUserId String
  notes           String? // Internal notes (not printed)
  events          Json    @default("[]") // Array of { type, at, by, details? }

  // Beneficiary (the student/user who receives the entitlements)
  beneficiaryUserId String?

  // Relations
  items        InvoiceItem[]
  accessTokens InvoiceAccessToken[]
  entitlements Entitlement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([customerEmail])
  @@index([issuedAt])
  @@index([createdByUserId])
  @@map("invoices")
}

// InvoiceItem ‚Äî Ligne de facture
model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Content
  label       String  // e.g. "Stage Intensif Maths ‚Äî Palier 2"
  description String? // Optional detail (clamp max 3 lines)
  productCode String? // Entitlement product code (e.g. STAGE_MATHS_P1, PREMIUM_LITE)
  qty         Int     @default(1)
  unitPrice   Int     // in millimes (1 TND = 1000)
  total       Int     // qty √ó unitPrice, in millimes

  // Ordering
  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@map("invoice_items")
}

// InvoiceSequence ‚Äî Atomic counter for invoice numbering
model InvoiceSequence {
  id        String @id @default(cuid())
  yearMonth Int    @unique // e.g. 202602
  current   Int    @default(0) // Last used number

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoice_sequences")
}

// ‚îÄ‚îÄ‚îÄ Trajectoire Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

enum TrajectoryStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

// Trajectoire ‚Äî Strategic progression plan for a student
model Trajectory {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Objective
  title       String // e.g. "Pr√©parer le Bac Maths"
  description String? // Detailed objective description
  targetScore Int? // Target Nexus Index score (0‚Äì100)

  // Horizon
  horizon   String // "3_MONTHS" | "6_MONTHS" | "12_MONTHS"
  startDate DateTime @default(now())
  endDate   DateTime

  // Status
  status TrajectoryStatus @default(ACTIVE)

  // Milestones (stored as JSON array for flexibility)
  milestones Json @default("[]") // Array of { id, title, targetDate, completed, completedAt }

  // Metadata
  createdBy String? // userId of who created it (coach, assistante, or auto)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, status])
  @@map("trajectories")
}

// Entitlement ‚Äî Product access right activated by invoice payment
model Entitlement {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  productCode     String            // e.g. STAGE_MATHS_P1, PREMIUM_LITE, CREDIT_PACK_10
  label           String            // Human-readable label (snapshot from invoice item)
  status          EntitlementStatus @default(ACTIVE)
  startsAt        DateTime          @default(now())
  endsAt          DateTime?         // null = permanent until revoked
  sourceInvoiceId String?
  sourceInvoice   Invoice?          @relation(fields: [sourceInvoiceId], references: [id], onDelete: SetNull)
  metadata        Json?             // { qty, credits, subject, level, ... }
  suspendedAt     DateTime?
  suspendReason   String?
  revokedAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, status])
  @@index([productCode])
  @@index([sourceInvoiceId])
  @@map("entitlements")
}

// InvoiceAccessToken ‚Äî Signed link for external PDF access (72h expiry)
model InvoiceAccessToken {
  id              String    @id @default(cuid())
  invoiceId       String
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tokenHash       String    @unique // SHA-256 hash of the raw token
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  createdByUserId String
  revokedAt       DateTime?

  @@index([invoiceId])
  @@map("invoice_access_tokens")
}

// ‚îÄ‚îÄ‚îÄ Document Management (Souverainet√© des Donn√©es) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model UserDocument {
  id           String   @id @default(cuid())
  title        String
  originalName String
  mimeType     String
  sizeBytes    Int
  
  // Chemin physique s√©curis√© (Hors dossier public)
  // Ex: /app/storage/documents/cl9...xyz.pdf
  localPath    String   @unique

  createdAt    DateTime @default(now())

  // Relations
  userId       String
  user         User     @relation("UserDocuments", fields: [userId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?    @relation("DocumentUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([uploadedById])
  @@map("user_documents")
}
